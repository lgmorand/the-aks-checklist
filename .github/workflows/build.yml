name: Validation Build 

on:
  pull_request:
    branches:
      - staging
      - master
  workflow_dispatch:

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check that data is OK
      run: . ./.github/scripts/check-unique-guid.sh

    - name: Run the Transformer
      run: |
        pushd ./data/scripts
        pip3 install pandas
        python ./transform_to_ft.py
        popd

    - name: Setup dotnet
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: | 
          8.0.x
    
    - name: Build the generator
      run: |
        dotnet publish -c Release -r linux-x64 --self-contained true
      working-directory: ./src/generator

    - name: Move the generator
      run: |
        mkdir -p ./data/tooling/html-generator
        cp ./src/generator/bin/Release/net8.0/linux-x64/publish/* ./data/tooling/html-generator/

    - name: Generate the checklist
      run: |
        chmod +x aks-generator.exe
        ./aks-generator.exe -i template.html -p "../../en" -o "../../../src/index.html"
      working-directory: ./data/tooling/html-generator

    - name: Setup tmate session
      if: ${{ failure() }}
      uses: mxschmitt/action-tmate@v3
      timeout-minutes: 15
      with:
        limit-access-to-actor: false
        

    - uses: actions/upload-artifact@v4
      with:
        name: CheckList
        path: src
